<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Style Vault</title>
    <meta name="apple-mobile-web-app-title" content="Style Vault">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;700&family=Syne:wght@700&display=swap');

:root {
  --teal: #1e5f74;
  --orange: #d9534f;
  --mustard: #e8a628;
  --cream: #f4eee0;
  --dark: #2d2926;
}

body {
  font-family: 'Space Grotesk', sans-serif;
  background-color: var(--cream);
  color: var(--dark);
  margin: 0;
  padding: 20px;
}

.container { max-width: 450px; margin: auto; }
header { text-align: center; margin-bottom: 40px; }

header h1 {
  font-family: 'Syne', sans-serif;
  font-size: 3rem;
  text-transform: uppercase;
  margin: 0;
  color: var(--teal);
  letter-spacing: -2px;
}

.subtitle {
  font-size: 0.7rem; letter-spacing: 3px; font-weight: 700;
  margin-top: 5px; color: var(--orange);
}

.atomic-star { font-size: 2rem; color: var(--mustard); margin-bottom: -10px; }

.upload-card, .stats-panel {
  background: white; padding: 20px; border: 3px solid var(--dark);
  box-shadow: 8px 8px 0px var(--mustard); margin-bottom: 30px;
}

.custom-file-upload {
  display: block; background: var(--teal); color: white; padding: 15px;
  text-align: center; cursor: pointer; font-weight: bold;
  text-transform: uppercase; border: 2px solid var(--dark);
}

#outfitName, #tagInput, #searchBar {
  width: 100%; padding: 12px; border: 2px solid var(--dark);
  background: #fdfaf5; font-family: 'Space Grotesk', sans-serif;
  box-sizing: border-box;
}

.add-btn {
  width: 100%; background: var(--orange); color: white;
  border: 2px solid var(--dark); padding: 12px; cursor: pointer;
  font-weight: bold; text-transform: uppercase;
}

/* Fixed Preview CSS */
.hidden { display: none !important; }

.preview-thumbnail-wrapper {
  text-align: center; padding: 10px; background: #fdfaf5;
  border: 1px dashed var(--teal); margin: 15px 0;
}

#imagePreview {
  width: 120px; height: 120px; object-fit: contain;
  border: 2px solid var(--dark); background: white;
}

/* Moodboard Canvas */
.moodboard-display {
  background-color: white; border: 2px solid var(--dark);
  min-height: 250px; display: flex; flex-wrap: wrap;
  justify-content: center; align-items: center; padding: 10px; gap: 5px;
}

#moodboardHint { font-size: 0.8rem; opacity: 0.5; text-align: center; }

.moodboard-item {
  width: 110px; height: 110px; object-fit: contain;
  filter: drop-shadow(4px 4px 0px rgba(0,0,0,0.05)); cursor: pointer;
}

/* Grid & Cards */
.grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

.item-card {
  background: white; border: 2px solid var(--dark);
  padding: 5px; box-shadow: 4px 4px 0px var(--teal);
}

.item-card img {
  width: 100%; height: 160px; object-fit: contain;
  background: radial-gradient(circle, #fff 0%, #fcfaf5 100%); cursor: copy;
}

.tag-pill {
  background: var(--mustard); color: var(--dark); font-size: 10px;
  padding: 4px 8px; margin: 2px; font-weight: bold;
  display: inline-block; cursor: pointer; border: 1px solid var(--dark);
}

.delete-btn {
  background: var(--dark); color: white; border: none;
  font-size: 10px; padding: 2px 6px; cursor: pointer;
}

.stats-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
.stat-item { background: var(--cream); border: 1px solid var(--dark); padding: 4px 8px; font-size: 0.75rem; font-weight: 700; }
    </style>
</head>
<body>
    <script>
        let closet = JSON.parse(localStorage.getItem('myCloset') || "[]");

function showPreview(input) {
  const container = document.getElementById('previewContainer');
  const img = document.getElementById('imagePreview');
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = (e) => {
      img.src = e.target.result;
      container.classList.remove('hidden'); // SHOW BOX
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function processAndSave() {
  const fileInput = document.getElementById('fileInput');
  const tagInput = document.getElementById('tagInput');
  const previewContainer = document.getElementById('previewContainer');
  const previewImg = document.getElementById('imagePreview');
  const file = fileInput.files[0];
  
  if (!file) return alert("Please select a photo first!");

  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const MAX_WIDTH = 500;
      canvas.width = MAX_WIDTH;
      canvas.height = img.height * (MAX_WIDTH / img.width);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      
      const tags = tagInput.value.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
      const newItem = {
        image: canvas.toDataURL('image/png'),
        tags: tags,
        id: Date.now()
      };
      
      closet.push(newItem);
      localStorage.setItem('myCloset', JSON.stringify(closet));
      
      // RESET AND HIDE
      tagInput.value = "";
      fileInput.value = "";
      previewImg.src = "";
      previewContainer.classList.add('hidden'); // HIDE BOX
      
      renderAll();
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

function addToMoodboard(imageUrl) {
  const canvas = document.getElementById('moodboardCanvas');
  const hint = document.getElementById('moodboardHint');
  if (hint) hint.remove();

  const img = document.createElement('img');
  img.src = imageUrl;
  img.className = 'moodboard-item';
  const randomRot = (Math.random() * 12 - 6).toFixed(2);
  img.style.transform = `rotate(${randomRot}deg)`;
  img.onclick = function() { this.remove(); };
  canvas.appendChild(img);
}

function clearMoodboard() {
  document.getElementById('moodboardCanvas').innerHTML = '<p id="moodboardHint">Click items below to add to your moodboard</p>';
  document.getElementById('outfitName').value = "";
}

async function saveMoodboard() {
  const moodboard = document.getElementById('moodboardCanvas');
  const items = moodboard.querySelectorAll('.moodboard-item');
  const name = document.getElementById('outfitName').value || "Untitled Look";
  if (items.length === 0) return alert("Add items to the moodboard first!");

  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = 1000; canvas.height = 1000;
  
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.fillStyle = "#1e5f74";
  ctx.font = "bold 45px sans-serif";
  ctx.fillText(name.toUpperCase(), 50, 80);
  ctx.fillStyle = "#d9534f";
  ctx.font = "20px sans-serif";
  ctx.fillText(`ARCHIVED: ${new Date().toLocaleDateString()}`, 50, 115);

  const drawImg = (src) => new Promise(res => {
    const i = new Image();
    i.onload = () => res(i);
    i.src = src;
  });

  let x = 60, y = 180;
  for (let item of items) {
    const img = await drawImg(item.src);
    ctx.drawImage(img, x, y, 280, 280);
    x += 310;
    if (x > 700) { x = 60; y += 310; }
  }

  const link = document.createElement('a');
  link.download = `${name.replace(/\s+/g, '-')}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

function renderAll(filter = "") {
  const grid = document.getElementById('closetGrid');
  const filtered = filter ? closet.filter(i => i.tags.includes(filter.toLowerCase())) : closet;
  
  grid.innerHTML = filtered.map(item => `
    <div class="item-card">
      <img src="${item.image}" onclick="addToMoodboard('${item.image}')">
      <div style="padding:5px; display:flex; justify-content:space-between;">
         <button class="delete-btn" onclick="deleteItem(${item.id})">âœ•</button>
         <button class="delete-btn" style="background:var(--teal)" onclick="enableEdit(${item.id})">EDIT</button>
      </div>
      <div id="tags-${item.id}" class="item-tags">
        ${item.tags.map(t => `<span class="tag-pill" onclick="renderAll('${t}')">${t}</span>`).join('')}
      </div>
    </div>
  `).reverse().join('');
  updateStats();
}

function enableEdit(id) {
  const item = closet.find(i => i.id === id);
  const tagDiv = document.getElementById(`tags-${id}`);
  tagDiv.innerHTML = `
    <input type="text" id="edit-i-${id}" value="${item.tags.join(', ')}" style="font-size:10px; width:70%;">
    <button onclick="saveEdit(${id})" style="font-size:10px; background:var(--dark); color:white; border:none; padding: 2px 5px;">OK</button>
  `;
}

function saveEdit(id) {
  const val = document.getElementById(`edit-i-${id}`).value;
  const idx = closet.findIndex(i => i.id === id);
  closet[idx].tags = val.split(',').map(t => t.trim().toLowerCase()).filter(t => t);
  localStorage.setItem('myCloset', JSON.stringify(closet));
  renderAll();
}

function deleteItem(id) {
  if (confirm("Delete this?")) {
    closet = closet.filter(i => i.id !== id);
    localStorage.setItem('myCloset', JSON.stringify(closet));
    renderAll();
  }
}

function updateStats() {
  const counts = {};
  closet.forEach(i => i.tags.forEach(t => counts[t] = (counts[t] || 0) + 1));
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
  document.getElementById('statsContent').innerHTML = sorted.map(([t, c]) => `
    <div class="stat-item">${t.toUpperCase()}: <span style="color:var(--teal)">${c}</span></div>
  `).join('') || "<em>Empty archive.</em>";
}

function exportCloset() {
    </script>
</body>

</html>
